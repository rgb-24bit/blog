<!DOCTYPE html>
<html lang="zh-CN">
<head>
<!-- 2018-08-12 周日 11:30 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Python 魔法方法</title>
<meta name="generator" content="Org mode">
<meta name="author" content="rgb_24bit">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://rgb-24bit.github.io/org-html-theme-list/org-note/style/main.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="https://rgb-24bit.github.io/blog/"> UP </a>
 |
 <a accesskey="H" href="https://rgb-24bit.github.io"> HOME </a>
</div><div id="content">
<h1 class="title">Python 魔法方法</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgfc0afc1">1. 简介</a></li>
<li><a href="#org4fb6290">2. 构造和初始化</a></li>
<li><a href="#orgc66111c">3. 比较和数值运算</a>
<ul>
<li><a href="#org6d68f65">3.1. 用于比较的魔法方法</a></li>
<li><a href="#org15aa7df">3.2. 数值处理的魔法方法</a></li>
</ul>
</li>
<li><a href="#orgfab7ed9">4. 类型转化</a></li>
<li><a href="#orgc1e853f">5. 表现类</a></li>
<li><a href="#org46b3a93">6. 属性访问控制</a></li>
<li><a href="#org253171a">7. 创建定制的序列</a></li>
<li><a href="#org69b2881">8. 反射</a></li>
<li><a href="#org666421a">9. 可以调用的对象</a></li>
<li><a href="#orge4e2adf">10. 上下文管理器</a></li>
<li><a href="#orgbe38dfb">11. 更多的方法</a></li>
<li><a href="#org386b808">12. 参考链接</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgfc0afc1" class="outline-2">
<h2 id="orgfc0afc1"><span class="section-number-2">1</span> 简介</h2>
<div class="outline-text-2" id="text-1">
<p>
在 <code>Python</code> 中， 你可以通过定义一些特殊的方法来控制一个对象的行为。
</p>

<p>
这些方法的名字常用名为 <b>魔法方法</b> 或 <b>魔术方法</b>.
</p>

<p>
当然了， 官方文档的名字更加直接， 叫做 <b>Special method</b>.
</p>

<p>
这篇博客主要借鉴 <a href="http://pycoders-weekly-chinese.readthedocs.io/en/latest/issue6/a-guide-to-pythons-magic-methods.html">Python 魔术方法指南</a> 对 <b>部分</b> 魔法方法进行总结。
</p>
</div>
</div>

<div id="outline-container-org4fb6290" class="outline-2">
<h2 id="org4fb6290"><span class="section-number-2">2</span> 构造和初始化</h2>
<div class="outline-text-2" id="text-2">
<p>
<code>Python</code> 一个对象实例化到销毁调用的方法的顺序是：
</p>
<pre class="example">
__new__() ==&gt; __init__() ==&gt; ... ==&gt; __del__()

</pre>

<p>
因为最常用的方法是 <code>__init__()</code>, 所以我一直认为最先调用的方法应该是 <code>__init__()</code>,
但结果居然还有一个 <code>__new__()</code>. 没人气的方法 <b>@_@</b>.
</p>

<dl class="org-dl">
<dt>__new__(cls[,&#x2026;]))</dt><dd>对象实例化的时候所调用的第一个方法， 它的第一个参数是这个类，
其他的参数是用来直接传递给 <code>__init__()</code> 方法。</dd>

<dt>__init__(self[, &#x2026;])</dt><dd>类的初始化方法。 可以说是最常用的方法了。 调用构造函数时
的参数就是传给它的。</dd>

<dt>__del__(self)</dt><dd>当实例即将被销毁时调用， 也被叫做析构函数。 <b>没有参数</b>.</dd>
</dl>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Test</span>(<span style="font-weight: bold;">object</span>):
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"Hello World !"</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__del__</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"Goodbye World QAQ"</span>)

<span style="font-weight: bold; font-style: italic;">T</span> = Test()
<span style="font-weight: bold;">del</span> T
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc66111c" class="outline-2">
<h2 id="orgc66111c"><span class="section-number-2">3</span> 比较和数值运算</h2>
<div class="outline-text-2" id="text-3">
<p>
一个有趣的例子：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">one list</span>
&gt;&gt;&gt; <span style="font-weight: bold; font-style: italic;">l</span> = [0]

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">one tuple</span>
&gt;&gt;&gt; <span style="font-weight: bold; font-style: italic;">t</span> = (1, )

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">list + tuple ?</span>
&gt;&gt;&gt; l + t
Traceback (most recent call last):
  File <span style="font-style: italic;">"&lt;stdin&gt;"</span>, line 1, <span style="font-weight: bold;">in</span> &lt;module&gt;
<span style="font-weight: bold; text-decoration: underline;">TypeError</span>: can only concatenate <span style="font-weight: bold;">list</span> (<span style="font-weight: bold;">not</span> <span style="font-style: italic;">"tuple"</span>) to <span style="font-weight: bold;">list</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">list += tuple ?</span>
&gt;&gt;&gt; <span style="font-weight: bold; font-style: italic;">l</span> += t
[0, 1]
</pre>
</div>

<p>
一个列表直接加一个元组会出错， 而 <code>+=</code> 没有问题&#x2026;
</p>

<p>
当时我很疑惑， 有大佬给出了解答：
<code>l + t</code> 对应的是 <code>l.__add__(t)</code> ，而 <code>l += t</code> 对应的是 <code>l.__iadd__(t)</code> ，实现可以是不同的.
</p>

<p>
当然， 大佬还说了这样的代码学习可以，就不要在实际操作中用了。
</p>
</div>

<div id="outline-container-org6d68f65" class="outline-3">
<h3 id="org6d68f65"><span class="section-number-3">3.1</span> 用于比较的魔法方法</h3>
<div class="outline-text-3" id="text-3-1">
<dl class="org-dl">
<dt>__cmp__(self, other)</dt><dd>最基本的用于比较的魔法方法， 现了所有的比较符号 <b>(&lt;,==,!=,etc.)</b>. 如果 <code>self &lt; other</code> 应该返回一个 <b>负数</b>, 如果
<code>self == other</code> 应该返回 <b>0</b>, 如果 <code>self &gt; other</code> 应该返回一个 <b>正数</b>.</dd>

<dt>__eq__(self, other)</dt><dd>定义了 <code>==</code> 行为， 相等返回 <code>True</code>, 反之返回 <code>False</code>.</dd>

<dt>__ne__(self, other)</dt><dd>定义了 <code>!=</code> 行为， 不等返回 <code>True</code>, 反之返回 <code>False</code>.</dd>

<dt>__lt__(self, other)</dt><dd>定义了 <code>&lt;</code> 行为， 小于返回 <code>True</code>, 反之返回 <code>False</code>.</dd>

<dt>__gt__(self, other)</dt><dd>定义了 <code>&gt;</code> 行为， 大于返回 <code>True</code>, 反之返回 <code>False</code>.</dd>
</dl>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Word</span>(<span style="font-weight: bold;">str</span>):
<span style="font-style: italic;">'''&#23384;&#20648;&#21333;&#35789;&#30340;&#31867;&#65292;&#23450;&#20041;&#27604;&#36739;&#21333;&#35789;&#30340;&#20960;&#31181;&#26041;&#27861;'''</span>

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__new__</span>(cls, word):
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#24847;&#25105;&#20204;&#24517;&#39035;&#35201;&#29992;&#21040;__new__&#26041;&#27861;&#65292;&#22240;&#20026;str&#26159;&#19981;&#21487;&#21464;&#31867;&#22411;</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25152;&#20197;&#25105;&#20204;&#24517;&#39035;&#22312;&#21019;&#24314;&#30340;&#26102;&#20505;&#23558;&#23427;&#21021;&#22987;&#21270;</span>
        <span style="font-weight: bold;">if</span> <span style="font-style: italic;">' '</span> <span style="font-weight: bold;">in</span> word:
            <span style="font-weight: bold;">print</span> <span style="font-style: italic;">"Value contains spaces. Truncating to first space."</span>
            <span style="font-weight: bold; font-style: italic;">word</span> = word[:word.index(<span style="font-style: italic;">' '</span>)] <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">&#21333;&#35789;&#26159;&#31532;&#19968;&#20010;&#31354;&#26684;&#20043;&#21069;&#30340;&#25152;&#26377;&#23383;&#31526;</span>
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">str</span>.__new__(cls, word)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__gt__</span>(<span style="font-weight: bold;">self</span>, other):
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">len</span>(<span style="font-weight: bold;">self</span>) &gt; <span style="font-weight: bold;">len</span>(other)
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__lt__</span>(<span style="font-weight: bold;">self</span>, other):
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">len</span>(<span style="font-weight: bold;">self</span>) &lt; <span style="font-weight: bold;">len</span>(other)
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__ge__</span>(<span style="font-weight: bold;">self</span>, other):
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">len</span>(<span style="font-weight: bold;">self</span>) &gt;= <span style="font-weight: bold;">len</span>(other)
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__le__</span>(<span style="font-weight: bold;">self</span>, other):
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">len</span>(<span style="font-weight: bold;">self</span>) &lt;= <span style="font-weight: bold;">len</span>(other)
</pre>
</div>

<p>
这里就直接可耻的盗用 <b>指南</b> 的例子了。
</p>
</div>
</div>

<div id="outline-container-org15aa7df" class="outline-3">
<h3 id="org15aa7df"><span class="section-number-3">3.2</span> 数值处理的魔法方法</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li><b>一元操作符和函数</b> 
<dl class="org-dl">
<dt>__pos__(self)</dt><dd>实现正号的特性, 如 <code>+object</code></dd>
<dt>__neg__(self)</dt><dd>实现负号的特性, 如 <code>-object</code></dd>
<dt>__abs__(self)</dt><dd>实现内置 <code>abs()</code> 函数的特性, 如 <code>abs(object)</code></dd>
<dt>__invert__(self)</dt><dd>实现 <code>~</code> 符号的特性, 参考文章: <a href="https://en.wikipedia.org/wiki/Bitwise_operation#NOT">Bitwise operation</a></dd>
</dl></li>

<li><b>普通算数操作符</b>
<dl class="org-dl">
<dt>__add__(self, other)</dt><dd>实现加法, 如 <code>A + B</code></dd>
<dt>__sub__(self, other)</dt><dd>实现减法, 如 <code>A - B</code></dd>
<dt>__mul__(self, other)</dt><dd>实现乘法, 如 <code>A * B</code></dd>
<dt>__floordiv__(self, other)</dt><dd>实现 <code>//</code> 除, 如 <code>A // B</code></dd>
<dt>__div__(self, other)</dt><dd>实现 <code>/</code> 除, 如 <code>A / B</code></dd>
<dt>__truediv__(self, other)</dt><dd><p>
实现真除法， 需要：
</p>
<pre class="example">
from __future__ import division

</pre></dd>
<dt>__mod__(self, other)</dt><dd>实现取模运算, 如 <code>A % B</code></dd>
<dt>__divmod___(self, other)</dt><dd>实现内置函数 <code>divmod()</code> 运算, 如 <code>divmod(obj)</code></dd>
<dt>__pow___(self, other[, modulo])</dt><dd>实现使用 <code>**</code> 的指数运算, 如 <code>A**2</code></dd>
<dt>__lshift__(self, other)</dt><dd>实现使用 <code>&lt;&lt;</code> 的按位左移运算, 如 <code>A &lt;&lt; B</code></dd>
<dt>__rshift__(self, other)</dt><dd>实现使用 <code>&gt;&gt;</code> 的按位右移运算, 如 <code>A &gt;&gt; B</code></dd>
<dt>__and__(self, other)</dt><dd>实现使用 <code>&amp;</code> 的按位与运算, 如 <code>A &amp; B</code></dd>
<dt>__or__(self, other)</dt><dd>实现使用 <code>|</code> 的按位或运算, 如 <code>A | B</code></dd>
<dt>__xor__(self, other)</dt><dd>实现使用 <code>^</code> 的按位异或运算, 如 <code>A ^ B</code></dd>
</dl></li>

<li><p>
<b>反运算</b>
</p>

<p>
指南给出的反运算的解释：
</p>
<pre class="example">
       一个普通的加法运算： some_object + other

       对应的反运算： other + some_object
</pre>

<p>
意思就是把操作数调了个位置， 大多数情况下，反运算的结果是与普通运算相同的。
</p>

<p>
具体的实现和 <b>普通算数操作符</b> 的实现差不多， 只需要在对应的运算前面加上一个 <code>r</code> 就可以了。
</p>

<p>
如： <code>__add__()</code> 对应 <code>__radd__()</code>.
</p>

<p>
<b>Update 2018-05-14:</b> 突然明白反运算是什么意思了：
</p>
<ul class="org-ul">
<li>self + other 就是正运算</li>
<li>other + self 就是反运算</li>
</ul></li>

<li><p>
<b>增量赋值</b>
</p>

<p>
这个就是比较熟悉的运算了， 就是类似于 <code>A += B</code> 的运算， 实现方式和 <b>普通算数操作符</b> 类似， 
只需要在对应的运算前面加上一个 <code>i</code> 就可以了。
</p>

<p>
如： <code>__add__()</code> 对应 <code>__iadd__()</code>. 
</p>

<p>
实际操作就是对应的运算符紧跟一个等号 <code>=</code>.
</p>

<p>
如： <code>+=</code>, <code>&gt;&gt;=</code>, <code>**=</code>&#x2026;
</p></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgfab7ed9" class="outline-2">
<h2 id="orgfab7ed9"><span class="section-number-2">4</span> 类型转化</h2>
<div class="outline-text-2" id="text-4">
<p>
可以通过一些 <b>魔法方法</b> 来实现内置类型类型转换， 注意， 是转换为 <b>内置类型</b>. 
</p>
<dl class="org-dl">
<dt>__int__(self)</dt><dd>实现整形的强制转换</dd>
<dt>__long__(self)</dt><dd>实现长整形的强制转换, 当然， 这应该是 <code>Python2</code> 的</dd>
<dt>__float__(self)</dt><dd>实现浮点型的强制转换</dd>
<dt>__complex__(self)</dt><dd>实现复数的强制转换</dd>
<dt>__oct__(self)</dt><dd>实现八进制的强制转换</dd>
<dt>__hex__(self)</dt><dd>实现二进制的强制转换</dd>
<dt>__index__(self)</dt><dd>当对象是被应用在 <b>切片表达式</b> 中时，实现整形强制转换</dd>
<dt>__trunc__(self)</dt><dd>当使用 <code>math.trunc(self)</code> 的时候被调用, 应该返回数值被截取成整形的值</dd>
<dt>__coerce__(self, other)</dt><dd>实现混合模式算数, 也是 <code>Python2</code> 的</dd>
</dl>

<p>
转换成什么类型就返回什么类型的值。
</p>
</div>
</div>

<div id="outline-container-orgc1e853f" class="outline-2">
<h2 id="orgc1e853f"><span class="section-number-2">5</span> 表现类</h2>
<div class="outline-text-2" id="text-5">
<dl class="org-dl">
<dt>__str__(self)</dt><dd>使用 <code>str(obj)</code> 会调用这个方法</dd>
<dt>__repr__(self)</dt><dd>使用 <code>repr(obj)</code> 会调用这个方法</dd>
<dt>__unicode(self)</dt><dd>使用 <code>unicode(obj)</code> 会调用这个方法， 当然这也是 <code>Python2</code> 的</dd>
<dt>__hash__(self)</dt><dd>使用 <code>hash(obj)</code> 会调用这个方法， 应该返回一个 <b>整型</b></dd>
<dt>__nonzero(self)</dt><dd>使用 <code>bool(obj)</code> 会调用这个方法， 应该返回 <code>True</code> 或 <code>False</code>.
在 <code>Python3</code> 中改为了 <code>__bool__().</code></dd>
</dl>
</div>
</div>

<div id="outline-container-org46b3a93" class="outline-2">
<h2 id="org46b3a93"><span class="section-number-2">6</span> 属性访问控制</h2>
<div class="outline-text-2" id="text-6">
<p>
作为动态语言， <code>Python</code> 一个对象的属性的访问是很开放的。 如果需要对属性的访问进行控制，
就可以使用这一部分的 <b>魔法方法</b>.
</p>

<dl class="org-dl">
<dt>__getattr__(self, name)</dt><dd>获取不存在的属性的值时会调用这个方法， 所以在这个方法内可以
获取正常属性的值。</dd>

<dt>__getattribute__(self, name)</dt><dd><p>
获取对象的属性时调用， 不管属性存不存在。 同时如果定义了这个方法， <code>__getattr__</code> 将
不起作用， 除非显示调用或引发 <code>AttributeError</code>.
</p>

<p>
由于获取任意属性都将调用这一方法， 所以如果在这个方法内获取属性将导致 <b>无限递归</b>.
</p>

<p>
解决这一问题的方法是把获取属性的方法指向一个更高的 <b>超类</b>:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ClassA</span>:
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__getattribute__</span>(<span style="font-weight: bold;">self</span>, item):
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">super</span>().__getattribute__(<span style="font-weight: bold;">self</span>, item)
</pre>
</div></dd>

<dt>__setattr__(self, name, value)</dt><dd><p>
定义设置对象的属性时的行为， 即 <code>obj.xxx = xxx</code> 时会调用这个方法
</p>

<p>
使用这个方法需要注意的一点：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__setattr__</span>(<span style="font-weight: bold;">self</span>, name, value):
    <span style="font-weight: bold;">self</span>.name = value
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27599;&#24403;&#23646;&#24615;&#34987;&#36171;&#20540;&#30340;&#26102;&#20505;&#65292; ``__setattr__()`` &#20250;&#34987;&#35843;&#29992;&#65292;&#36825;&#26679;&#23601;&#36896;&#25104;&#20102;&#36882;&#24402;&#35843;&#29992;</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#24847;&#21619;&#36825;&#20250;&#35843;&#29992; ``self.__setattr__('name', value)`` &#65292;&#27599;&#27425;&#26041;&#27861;&#20250;&#35843;&#29992;&#33258;&#24049;&#12290;&#36825;&#26679;&#20250;&#36896;&#25104;&#31243;&#24207;&#23849;&#28291;</span>

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__setattr__</span>(<span style="font-weight: bold;">self</span>, name, value):
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36890;&#36807;&#36825;&#31181;&#26041;&#24335;&#26469;&#36991;&#20813;</span>
    <span style="font-weight: bold;">self</span>.__dict__[name] = value  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32473;&#31867;&#20013;&#30340;&#23646;&#24615;&#21517;&#20998;&#37197;&#20540;</span>
</pre>
</div>

<p>
设置 <b>实例</b> 属性会调用这个方法， 包括在 <code>__init__</code> 中设置属性。 但类属性不受影响。
</p></dd>

<dt>__delattr__(self, name)</dt><dd>定义删除对象的属性时的行为， 即 <code>del obj.xxx</code> 时会调用这个方法</dd>
</dl>

<p>
对于这一部分的 <b>魔法方法</b>, 每个 <b>对象</b> 的 <code>__dict__</code> 属性应该是一个很重要的内容， 有兴趣可以
了解一下 ☞ <a href="https://docs.python.org/3/library/stdtypes.html?highlight=__dict__#object.__dict__">object.__dict__</a>.
</p>
</div>
</div>

<div id="outline-container-org253171a" class="outline-2">
<h2 id="org253171a"><span class="section-number-2">7</span> 创建定制的序列</h2>
<div class="outline-text-2" id="text-7">
<p>
<code>Python</code> 中的序列有 <b>可变</b> 和 <b>不可变</b> 的区分， 比如 <code>tuple</code> 和 <code>list</code>.
</p>

<p>
通过魔法方法的定义来控制创建的序列的类型：
</p>
<ul class="org-ul">
<li><b>不可变</b>: 只能定义 <code>__len__</code> 和 <code>__getitem__</code>.</li>
<li><b>可变</b>: 需要定义 <code>__setitem__</code> 和 <code>__delitem__</code>.</li>
<li><b>可迭代</b>: 需要定义 <code>__iter__</code> 返回一个迭代器</li>
</ul>

<p>
这些魔法方法的具体作用：
</p>
<dl class="org-dl">
<dt>__len__(self)</dt><dd>使用 <code>len(obj)</code> 的时候调用， 返回序列的长度</dd>
<dt>__getitem__(self, key)</dt><dd>使用 <code>obj[key]</code> 时调用， 返回序列指定键的值</dd>
<dt>__setitem__(self, key, value)</dt><dd>使用 <code>obj[key] = value</code> 时调用， 设置序列指定键的值</dd>
<dt>__delitem__(self, key)</dt><dd>使用 <code>del obj[key]</code> 时调用， 删除序列指定条目</dd>
<dt>__iter__(self)</dt><dd>返回迭代器， <code>iter(obj)</code></dd>
<dt>__reversed__(self)</dt><dd>使用 <code>reversed(obi)</code> 时调用， 反转序列</dd>
<dt>__contains__(self, item)</dt><dd>使用 <code>item in obj</code> 和 <code>item not in obj</code> 时调用， 检测成员是否存在</dd>
<dt>__concat__(self, other)</dt><dd>连接两个序列的时候调用</dd>
</dl>
</div>
</div>

<div id="outline-container-org69b2881" class="outline-2">
<h2 id="org69b2881"><span class="section-number-2">8</span> 反射</h2>
<div class="outline-text-2" id="text-8">
<p>
通过魔法方法控制使用 <code>isinstance</code> 和 <code>issubclass</code> 的反射行为：
</p>
<dl class="org-dl">
<dt>__instancecheck__(self, instance)</dt><dd>检查一个实例是不是定义的类的实例, 对应 <code>isinstance</code></dd>
<dt>__subclasscheck__(self, subclass)</dt><dd>检查一个类是不是定义的类的子类, 对应 <code>issubclass</code></dd>
</dl>
</div>
</div>

<div id="outline-container-org666421a" class="outline-2">
<h2 id="org666421a"><span class="section-number-2">9</span> 可以调用的对象</h2>
<div class="outline-text-2" id="text-9">
<p>
如果你希望可以向调用函数那样调用你的 <b>对象</b>, 那么你可以定义那个对象的 <code>__call__</code> 方法。
</p>

<dl class="org-dl">
<dt>__call__(self, [args&#x2026;])</dt><dd>使用 <code>obj(...)</code> 时调用</dd>
</dl>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Test</span>(<span style="font-weight: bold;">object</span>):
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">self</span>.val = 10

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__call__</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">self</span>.val

<span style="font-weight: bold; font-style: italic;">t</span> = Test()
t()
</pre>
</div>
</div>
</div>

<div id="outline-container-orge4e2adf" class="outline-2">
<h2 id="orge4e2adf"><span class="section-number-2">10</span> 上下文管理器</h2>
<div class="outline-text-2" id="text-10">
<p>
<code>Python</code> 中使用 <code>with</code> 可以写出更加简洁高效的代码， 而能够使用 <code>with</code> 的对象需要支持上下文管理器。
</p>

<p>
上下文管理器需要两个方法： <code>__enter__</code> 和 <code>__exit__</code>.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">with</span> expression [<span style="font-weight: bold;">as</span> variable]:
    <span style="font-weight: bold;">with</span>-block
</pre>
</div>

<dl class="org-dl">
<dt>__enter__(self)</dt><dd>这个方法在进入 <code>with-block</code> 之前调用, 返回值被 <code>with</code> 的目标或 <code>as</code> 后的名字绑定</dd>
<dt>__exit__(self, exception_type, exception_value, traceback)</dt><dd>这个方法在退出 <code>with-block</code> 时调用</dd>
</dl>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Closer</span>(<span style="font-weight: bold;">object</span>):
    <span style="font-style: italic;">'''&#36890;&#36807;with&#35821;&#21477;&#21644;&#19968;&#20010;close&#26041;&#27861;&#26469;&#20851;&#38381;&#19968;&#20010;&#23545;&#35937;&#30340;&#20250;&#35805;&#31649;&#29702;&#22120;'''</span>

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>, obj):
    <span style="font-weight: bold;">self</span>.obj = obj

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__enter__</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">self</span>.obj <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">bound to target</span>

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__exit__</span>(<span style="font-weight: bold;">self</span>, exception_type, exception_val, trace):
        <span style="font-weight: bold;">try</span>:
            <span style="font-weight: bold;">self</span>.obj.close()
        <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">AttributeError</span>: <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">obj isn't closable</span>
            <span style="font-weight: bold;">print</span> <span style="font-style: italic;">'Not closable.'</span>
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">True</span> <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">exception handled successfully</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbe38dfb" class="outline-2">
<h2 id="orgbe38dfb"><span class="section-number-2">11</span> 更多的方法</h2>
<div class="outline-text-2" id="text-11">
<p>
<code>Python</code> 的魔法方法还有不少， <code>Python2</code> 和 <code>Python3</code> 在这方面也有一定的区别。
</p>
</div>
</div>

<div id="outline-container-org386b808" class="outline-2">
<h2 id="org386b808"><span class="section-number-2">12</span> 参考链接</h2>
<div class="outline-text-2" id="text-12">
<ul class="org-ul">
<li><a href="https://docs.python.org/2.7/reference/datamodel.html#special-method-names">Python2.7 Special method names</a></li>
<li><a href="https://docs.python.org/3/reference/datamodel.html#special-method-names">Python3.6 Special method names</a></li>
<li><a href="http://pycoders-weekly-chinese.readthedocs.io/en/latest/issue6/a-guide-to-pythons-magic-methods.html">Python 魔术方法指南</a></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
版权声明:自由转载-非商用-非衍生-保持署名(<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)
           <div id="disqus_thread"></div>
           <script type="text/javascript">
             var disqus_shortname = 'rgb-24bit';
             (function() {
               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
               dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
             })();
           </script>
</div>
</body>
</html>
